<html>
<head>
<title> SECTION 1 : HISTORICAL POLITICAL DATA VISUALIZATION</title>
</head>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<link rel="stylesheet" type="text/css" href="Style/main.css">
<body>
<div id="mainVisualization" style= "position:absolute"></div>
<script>

// Background Color
$('body').css("background-color","#f9f6ea");

var categories = ["GEN","SC","ST"];
var category_colors = [0,0.5,1.0];

var parties = ["BJP","INC","AIRJP","IND","JD","SP","JD(U)","NCP","BJNKP","GPP"];
var party_colors = ['#fc8d62','#66c2a5','#8da0cb','#ffd92f','#e78ac3','#a6d854','#e5c494','#f44b42',"#454a9b","#9bed87"];

// SVG for the visualization 
var visualization_size = (window.innerHeight<window.innerWidth)?window.innerHeight:window.innerWidth;

var mainVisualizationCanvas = d3.select("#mainVisualization")
	 .append("svg")
     .attr("id","main")
     .attr("xmlns","http://www.w3.org/2000/svg")
     .attr("viewBox","0 0 1000 1000")
     .attr("width",visualization_size)
     .attr("height",visualization_size)
     .attr("class", "mainsvg");

var viz_size = 1000;
var arc_width = 30;
var category_arc_width = 3; 
var radius_scale = d3.scaleLinear()
						.range([200,viz_size/2-50]);

d3.csv("Data/Final_Political_Data.csv",function(error,data)
{
	if(error) throw error;

	var years = d3.nest()
				  .key(function(d){ return d.Year})
				  .entries(data);

	radius_scale.domain(d3.extent(years,function(d,i){
		return parseInt(d.key);
	}))

	var constituency_data_temp_1 = d3.nest()
							.key(function(d){ return d.AC_Name})
							.entries(data)

	// SORT HERE !
	var constituency_data_temp_2 = [];
	parties.forEach(function(p,i){
		constituency_data_temp_1.forEach(function(d,i){
		if(d.values.length==4)
		{
			if(d.values[3].Party == p)
			{
				constituency_data_temp_2.push(d);
			}
		}
		else if (d.values.length==3)
		{
			if(d.values[2].Party == p)
			{
				constituency_data_temp_2.push(d);
			}
		}
		else if(d.values.length==1)
		{
			if(d.values[0].Party == p)
			{
				constituency_data_temp_2.push(d);
			}
		}
	})
	})
	
	var constituency_data = constituency_data_temp_1;

	console.log(constituency_data)
	
	var label_angle = 30;
	var label_angle_rad = (label_angle/180)*Math.PI;
	var angle = (2*Math.PI-label_angle_rad)/constituency_data.length;

	var constituency_text = mainVisualizationCanvas.append("g")
								.attr("transform","translate(500,470)")
								.append("text")
								.attr("id","selected_const_text")
								.text("HOVER OVER !");

	var candidate_text = mainVisualizationCanvas.append("g")
								.attr("transform","translate(500,495)")
								.append("text")
								.attr("id","selected_candi_text")
								.text("");

	var party_type_text = mainVisualizationCanvas.append("g")
								.attr("transform","translate(500,540)")
								.append("text")
								.attr("id","selected_party_text")
								.attr("opacity",0.6)
								.text(" ");

	var const_party_arc = d3.arc()
					.innerRadius(function(d,i){
						var innerRadius = radius_scale(parseInt(d.Year));
						return innerRadius-arc_width/2;
					})
					.outerRadius(function(d,i){
						return (radius_scale(parseInt(d.Year))+arc_width/2)
					})
					.startAngle(function(d,i){
						var index = constituency_data.findIndex(data=>data.key == d.AC_Name);
						return index*angle;
					})
					.endAngle(function(d,i){
						var index = constituency_data.findIndex(data=>data.key == d.AC_Name);
						return (index+1)*angle;
					})


	function toTitleCase(string)
	{
		var split_string=string.split("_");
		var new_string=[];
		for ( var a =0 ; a<split_string.length ;a++)
		{
			var m = split_string[a][0].toUpperCase();
			var conti = split_string[a].slice([1]).toLowerCase();
			new_string.push(m+conti);
		}
		var joined = new_string.join(" ");
		return joined;
	}

	var const_party = mainVisualizationCanvas.append("g")
								.attr("id","constituency_party")
								.attr("transform","translate(500,500) rotate("+(180+label_angle/2)+")")
								.selectAll("g")
								.data(constituency_data)
								.enter()
								.append("g")
								.attr("id",function(d,i){return(d.key)+"_constituency_party_viz"}).selectAll("path")
							.data(function(d,i){return d.values})
							.enter()
							.append("path")
							.attr("class","party_arcs")
							.attr("id",function(d,i){
								return d.AC_Name+"_"+d.Year+"_party_viz";
							})
							.attr("d",const_party_arc)
							.attr("fill",function(d,i){
								var col_id = parties.findIndex(data=>data==d.Party);
								return party_colors[col_id];
							})
							.attr("stroke","#f9f6ea")
							.attr("stroke-width",0.3)
							.on("mouseover",function(d,i){
								$(".party_arcs").attr("opacity",0.2)
								for ( var y = 0; y<years.length ;y++)
								{
									var id = d.AC_Name+"_"+years[y].key+"_party_viz";
									$("#"+id).attr("opacity",0.6);
								}

								$("#"+d.AC_Name+"_"+d.Year+"_party_viz").attr("opacity",1.0);

								$("#selected_const_text").text(
									(d.AC_Name).split("_").join(" "));

								$("#selected_candi_text").text(
									toTitleCase(d.Cand));
								console.log(d);
								$("#selected_party_text").text(
									d.AC_Type + " | " + d.Party + " | " +d.Turnout +"%");
							})
							.on("mouseout",function(d,i){
								$(".party_arcs").attr("opacity",1.0)
							})


	var const_category_arc = d3.arc()
					.innerRadius(function(d,i){
						var innerRadius = radius_scale(parseInt(d.Year));
						return innerRadius-arc_width/2;
					})
					.outerRadius(function(d,i){
						return (radius_scale(parseInt(d.Year))-arc_width/2+category_arc_width)
					})
					.startAngle(function(d,i){
						var index = constituency_data.findIndex(data=>data.key == d.AC_Name);
						return index*angle;
					})
					.endAngle(function(d,i){
						var index = constituency_data.findIndex(data=>data.key == d.AC_Name);
						return (index+1)*angle;
					})

	var const_category = mainVisualizationCanvas.append("g")
							.attr("id","constituency_category")
							.attr("transform","translate(500,500) rotate("+(180+label_angle/2)+")")
							.selectAll("g")
							.data(constituency_data)
							.enter()
							.append("g")
							.attr("id",function(d,i){return(d.key)+"_constituency_category_viz"}).selectAll("path")
							.data(function(d,i){return d.values})
							.enter()
							.append("path")
							.attr("class","category_arcs")
							.attr("id",function(d,i){
								return d.AC_Name+"_"+d.Year+"_category_viz";
							})
							.attr("d",const_category_arc)
							.attr("fill","black")
							.attr("opacity",function(d,i){
								var col_id = categories.findIndex(data=>data==d.AC_Type);
								return category_colors[col_id];
							})
							.attr("stroke","black")
							.attr("stroke-width",0);



	var grid_arc = d3.arc()
					.innerRadius(radius_scale(1998)-arc_width/2)
					.outerRadius(radius_scale(2012)+arc_width/2)
					.startAngle(function(d,i){
						return i*angle;
					})
					.endAngle(function(d,i){
						return (i+1)*angle;
					})

	var grid = mainVisualizationCanvas.append("g")
								.attr("id","constituency_grid")
								.attr("transform","translate(500,500) rotate("+(180+label_angle/2)+")")
								.selectAll("path")
								.data(constituency_data)
								.enter()
								.append("path")
								.attr("id",function(d,i){return(d.key)+"_constituency_grid"})
								.attr("d",grid_arc)
								.attr("fill","none")
								.attr("opacity",0.3)
								.attr("stroke","black")
								.attr("stroke-width",0.1)


});


</script>	


</body>
</html>